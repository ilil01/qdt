                  Описание регистров устройств для QDT

Набор программ QEMU Development Toolkit (QDT), среди прочего, поддерживает
генерацию заготовок для периферийных устройств.
Заготовка состоит из кода, формально удовлетворяющего требования внутреннего
API QEMU, но не несущего конкретной логики работы.
Этот код называется "интерфейсным".
Генерация заготовки избавляет разработчика от необходимости искать или помнить
наизусть достаточно больше количество формального кода для взаимодействия
с программным интерфейсом эмулятора.
Вместо этого он может сразу переходить к реализации остальной
(т.н. "индивидуальной") части кода устройства.
Генерация интерфейсной части основывается на формальной модели, описывающей
возможные способы взаимодействия устройства с инфраструктуры эмулятора.
В общем случае, индивидуальная часть устройства не может быть формализована,
т.к. все устройства разные, а описание устройства предоставляется
производителем на естественном языке.
Поэтому изначально QDT не поддерживал её генерацию.
Однако в течение разработки разнообразных устройств удалось выделить некоторые
часто используемые виды регистров устройств:

- регистры только для чтения;
- регистры для чтения и записи;
- регистры-пустышки;
- регистры только для записи.

Регистры для чтения и записи часто разбиты на битовые поля.
Битовые поля, в свою очередь, бывают следующих типов:

- только для чтения;
- для чтения и записи;
- для чтения и записи при условии предварительного чтения (извне)
с момента последнего изменения этого поля устройством.
- для однократной записи с момента сброса.

Регистры-пустышки используются для заполнения неиспользуемых интервалов в
банках регистров устройств.
При обращении к ним выводятся отладочные предупреждения, т.к. это может
свидетельствовать о неверном размещении регистров.

Регистры только для записи при чтении ведут себя как регистры-пустышки.

На основе этой классификации была разработана модель регистров устройств,
выраженная в расширении для API, используемого QDT для настройки генерации
заготовок.
По списку регистров QDT генерирует блоки `switch-case` в обработчиках
чтения и записи банка регистров устройства.
В блоки вставляется вспомогательный код, реализующий логику, соответствующую
виду регистра и его битовых полей.
В последствие, разработчик дополнит этот код более подробной логикой, если
нужно.
Некоторые виды регистров (битовых полей) подразумевают присутствие
дополнительного кода в других частях заготовки.
Размещение этого кода также происходит автоматически.
Например, допускающие запись регистры должны сохраняться в снимке состояния.
Поэтому их нужно зарегистрировать в структуре, описывающей состояние
устройства.
Также необходимо выполнять сброс регистров в начальное состояние.

Размер заготовки кода регистров приблизительно в два раза больше описания
этих регистров на разработанном расширении API.
Это вызвано тем, что в API регистры описываются в одном месте, а обработчиков
чтения-записи блока регистров --- два.
Также автоматическое создание дополнительных связанных кусков кода по всей
модели устройства исключает ошибки, обычно возникающие при ручном наборе.

